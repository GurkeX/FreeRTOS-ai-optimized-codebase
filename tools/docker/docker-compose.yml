# =============================================================================
# AI-Optimized FreeRTOS — Docker Compose Configuration
# =============================================================================
# Services:
#   build  — Compile firmware inside hermetic environment
#   flash  — Build + flash via SWD probe (requires USB passthrough)
# =============================================================================

services:
  build:
    image: ai-freertos-build
    user: "${UID:-1000}:${GID:-1000}"
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Mount project source (read-write)
      - ../../:/workspace
      # Bind mount for build output (visible on host)
      - ../../build:/workspace/build
    environment:
      - HOME=/tmp
      - PICO_SDK_PATH=/workspace/lib/pico-sdk
      - FREERTOS_KERNEL_PATH=/workspace/lib/FreeRTOS-Kernel
    working_dir: /workspace
    command: >
      bash -c "
        mkdir -p build && cd build &&
        cmake .. -G Ninja &&
        ninja
      "

  flash:
    image: ai-freertos-build
    user: "${UID:-1000}:${GID:-1000}"
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ../../:/workspace
      - ../../build:/workspace/build
      # Bind mount (sees new devices after hot-plug)
      - /dev/bus/usb:/dev/bus/usb
      # udev metadata for libusb device discovery
      - /run/udev:/run/udev:ro
    # Robust USB passthrough: cgroup rule for USB device major number
    device_cgroup_rules:
      - 'c 189:* rmw'
    environment:
      - HOME=/tmp
      - PICO_SDK_PATH=/workspace/lib/pico-sdk
      - FREERTOS_KERNEL_PATH=/workspace/lib/FreeRTOS-Kernel
    working_dir: /workspace
    command: >
      bash -c "
        mkdir -p build && cd build &&
        cmake .. -G Ninja &&
        ninja &&
        openocd -f interface/cmsis-dap.cfg -f target/rp2040.cfg \
          -c 'adapter speed 5000' \
          -c 'program build/firmware/app/firmware.elf verify reset exit'
      "

  # Production build — stripped, optimized firmware
  build-production:
    image: ai-freertos-build
    user: "${UID:-1000}:${GID:-1000}"
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ../../:/workspace
    environment:
      - HOME=/tmp
      - PICO_SDK_PATH=/workspace/lib/pico-sdk
      - FREERTOS_KERNEL_PATH=/workspace/lib/FreeRTOS-Kernel
    working_dir: /workspace
    command: >
      bash -c "
        cmake -B build-production -DBUILD_PRODUCTION=ON -DCMAKE_BUILD_TYPE=MinSizeRel -G Ninja &&
        ninja -C build-production
      "

  # Size comparison report for dev vs production builds
  size-report:
    image: ai-freertos-build
    user: "${UID:-1000}:${GID:-1000}"
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ../../:/workspace
    working_dir: /workspace
    command: >
      bash -c "
        echo '=== DEV BUILD ===' &&
        arm-none-eabi-size build/firmware/app/firmware.elf 2>/dev/null || echo 'No dev build found' &&
        echo '' &&
        echo '=== PRODUCTION BUILD ===' &&
        arm-none-eabi-size build-production/firmware/app/firmware.elf 2>/dev/null || echo 'No production build found'
      "

  # Persistent OpenOCD server for ahi_tool.py, run_hw_test.py, and RTT
  hil:
    image: ai-freertos-build
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ../../:/workspace
      - ../../build:/workspace/build
      - /dev/bus/usb:/dev/bus/usb
      - /run/udev:/run/udev:ro
    device_cgroup_rules:
      - 'c 189:* rmw'
    environment:
      - PICO_SDK_PATH=/workspace/lib/pico-sdk
      - FREERTOS_KERNEL_PATH=/workspace/lib/FreeRTOS-Kernel
    working_dir: /workspace
    ports:
      - "3333:3333"   # GDB server
      - "4444:4444"   # Telnet
      - "6666:6666"   # TCL RPC
      - "9090:9090"   # RTT Channel 0 (text)
      - "9091:9091"   # RTT Channel 1 (binary logs — BB2)
      - "9092:9092"   # RTT Channel 2 (binary telemetry — BB4)
    command: >
      openocd -f tools/hil/openocd/pico-probe.cfg
              -f tools/hil/openocd/rtt.cfg
              -c "bindto 0.0.0.0"
